---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Flow cytometry

Flow cytometry data can be quantified in many different ways and with different techniques. For the purpose of these data analyses, manual gating has been achieved in FlowJo and cell frequencies and populations exported as a `.csv` file. This `.csv` file is the primary input for this R pipeline which aims to output box plots for each gated cell population. 

This example data set is from an innate response study whcih investigated the immune response in the lungs during the first 28 days of infection.

----------------------------------------------------------------------------------

Immune cells are very diverse, and the make-up of immune cells within a sample
can provide important insights on immune processes based on measures of this
composition. Immune cells can be categorized into large groups (e.g., T cells, B
cells, macrophages, dendritic cells). They can also be characterized into
different populations within these large groups, based on things like activation
and differentiation [?] within the group [?] [@maecker2012standardizing] (e.g.,
T cells can be divided into naive T cells versus memory T cells, helper T cells
versus cytotoxic T cells, [others] [?]). This process of characterizing the
immune cells in a sample is called immunophenotyping.

To make these classifications, flow cytometry uses a pretty clever mix of 
physics and biology. First, it starts by leveraging the biological knowledge
that antibodies can have a very specific affinity for a certain protein. 
This means that you can find a set of antibodies that will target and 
stick specifically to certain proteins. 

Flow cytometry starts by creating a panel of up to [x] protein markers, focusing
on proteins that can help in identifying a specific cell type. Typically, the 
panel will include several proteins that are "CD" proteins (the "CD" stands for
cluster of differentiation or classification determinant). These are proteins
that show up on the surface of immune cells, with specific CD proteins common 
to only certain types of cells, making their presence or absence helpful in 
classifying cells. 

Two of the most common CDs to include on a panel are CD3, CD4, and CD8. T cells have
CD3 on their surface, so a marker for CD3 can be used to distinguish T cells
from other types of white blood cells, including granulocytes, monocytes, and
B cells. Among T cells, the helper T cells have the CD4 protein on their surface, 
while the cytotoxic T cells have the CD8 protein on their surface, so the CD4 
and CD8 markers can help in refining a T cell into a more specific type. 

In flow cytometry, you can characterize immune cells into populations based on
proteins on the cell surface and inside the cell, as well as cell size and
granularity [@maecker2012standardizing, @barnett2008cd4]. For example,
macrophages can be distinguished from T cells and B cells based on ... [size?
granularity?], which T cells and B cells can be distinguished from each other
based on whether the cell has the [surface protein? CD3?], and helper T cells
versus cytotoxic T cells can be distinguished from each other based on whether
the cell has the [surface protein CD8? CD4?].

## Loading packages

```{r}
library(readxl)
library(ggplot2)
library(RColorBrewer)
library(dplyr)
library(tidyverse)
library(scales)
library(stringr)
library(tidyr)
library(knitr)
library(forcats)
library(broom)
library(ggfortify)
library(stats)
library(ggpubr)
library(grDevices)
library(rstatix)
library(writexl)

```

## panel information

```{r}
# antibody_panel <- read_excel
```

## Loading data

```{r}
Df <- read_excel("DATA/innate_normalizedto45.xlsx", sheet = "CD3CD11b No Day 14")

marker_legend <- read_excel("DATA/marker legend.xlsx")

# Remove Freq of Parent columns
Df1 <- Df %>% 
  select(-matches("Parent"))
# Remove "Leukocytes/LIVE/Single Cells/" from col names
names(Df1) <- str_remove(names(Df1), "Leukocytes/LIVE/Single Cells/")

Df1 <- Df1 %>%
  rename_all(funs(str_replace(., "\\|.+", "")))# Remove "|Freq of..." from col names

Df1 <- Df1 %>%
  rename_all(funs(str_replace_all(., "\\/Q[:digit:]+\\:", ""))) %>%
  rename_all(funs(str_replace(., "\\/", " "))) %>%
  rename_all(funs(str_replace(., "\\,", " "))) %>%
  rename_all(funs(str_replace(., "\\ \\,", " ")))

# str_extract_all(names(Df1), "[:alpha:]+[:digit:]+[\\+\\-]")
# 
# 
# 
# 
# 
# 
# marker_select <- function(col_title) {
#   marker_df <- str_detect(names(DATA1), "[\\+\\-]") 
#   return(marker_df)
# }

```

## Making the data tidy for plotting


```{r}
tidy_Df1 <- pivot_longer(data = Df1, cols =  starts_with("CD45+"), names_to = "cell_types", values_to = "percentage_of_CD45") 

tidy_Df1 <- tidy_Df1 %>%
  separate(col = "SAMPLE", into = c("day", "replicate"))


tidy_Df1 %>%
  select(cell_types) %>%
  unique()

tidy_Df1 <- tidy_Df1 %>%
  filter(percentage_of_CD45 > 0.005)

head(tidy_Df1, n=10)
```

```{r}
# Select CD3 & CD11b populations and create new data frames 
 
CD3pos_CD11bneg <- tidy_Df1 %>%
  filter(str_detect(cell_types, "CD3\\+ + CD11b\\-")) 

CD3neg_CD11bpos <- tidy_Df1 %>%
  filter(str_detect(cell_types, "CD3\\- + CD11b\\+")) 

CD3neg_CD11bneg <- tidy_Df1 %>%
  filter(str_detect(cell_types, "CD3\\- + CD11b\\-"))

```


## boxplot
```{r, fig.width = 5, fig.height= 20}
CD3pos_CD11bneg_bar_plot <- CD3pos_CD11bneg %>%
mutate(day = fct_relevel(day,
            "CNT", "D3", "D7",
            "D28")) %>%
  ggplot(aes(x = day, y = percentage_of_CD45, fill= day)) +
  stat_boxplot( aes(day, percentage_of_CD45), 
    geom='errorbar', linetype=1, width=0.5)+  
  geom_boxplot(aes(day, percentage_of_CD45)) + 
  facet_wrap(~cell_types, scale = "free_y", labeller = label_wrap_gen(width=15), ncol = 5, nrow = 20) + 
  theme_bw() + 
  theme(axis.text.x = element_blank(), axis.text.y = element_text(size = 20), 
        axis.title.x = element_text(size = 20, face = "bold"), 
        axis.title.y = element_text(size = 20, face = "bold"), 
        legend.text = element_text(size = 20), 
        legend.title = element_text(size = 20), 
        plot.title = element_text(color="black", size=30, face="bold")) + 
  labs (y="Percentage of CD45", x = "Day") + 
  theme(strip.text = element_text(size=12, face = "bold")) + theme(legend.position="bottom") +
  ggtitle("Changes in immune cell populations (lung) CD3+ CD11b-") +
  stat_compare_means(label = "p.signif", method = "t.test",
                     ref.group = "CNT")



CD3neg_CD11bpos_bar_plot <- CD3neg_CD11bpos %>%
mutate(day = fct_relevel(day, 
            "CNT", "D3", "D7", 
            "D28")) %>%
  ggplot(aes(x = day, y = percentage_of_CD45, fill= day)) +
  stat_boxplot( aes(day, percentage_of_CD45), 
    geom='errorbar', linetype=1, width=0.5)+  
  geom_boxplot( aes(day, percentage_of_CD45)) + 
  facet_wrap(~cell_types, scale = "free_y", labeller = label_wrap_gen(width=15), ncol = 5, nrow = 20) + 
  theme_bw() + 
  theme(axis.text.x = element_blank(), axis.text.y = element_text(size = 20), 
        axis.title.x = element_text(size = 20, face = "bold"), 
        axis.title.y = element_text(size = 20, face = "bold"), 
        legend.text = element_text(size = 20), 
        legend.title = element_text(size = 20), 
        plot.title = element_text(color="black", size=30, face="bold")) + 
  labs (y="Percentage of CD45", x = "Day") + 
  theme(strip.text = element_text(size=12, face = "bold")) + theme(legend.position="bottom") +
  ggtitle("Changes in immune cell populations (lung) CD3- CD11b+") +
  stat_compare_means(label = "p.signif", method = "t.test",
                     ref.group = "CNT")



CD3neg_CD11bneg_bar_plot <- CD3neg_CD11bneg %>%
mutate(day = fct_relevel(day, 
            "CNT", "D3", "D7", 
            "D28")) %>%
  ggplot(aes(x = day, y = percentage_of_CD45, fill= day)) +
  stat_boxplot( aes(day, percentage_of_CD45), 
    geom='errorbar', linetype=1, width=0.5)+  
  geom_boxplot( aes(day, percentage_of_CD45)) + 
  facet_wrap(~cell_types, scale = "free_y", labeller = label_wrap_gen(width=15), ncol = 5, nrow = 20) + 
  theme_bw() + 
  theme(axis.text.x = element_blank(), axis.text.y = element_text(size = 20), 
        axis.title.x = element_text(size = 20, face = "bold"), 
        axis.title.y = element_text(size = 20, face = "bold"), 
        legend.text = element_text(size = 20), 
        legend.title = element_text(size = 20), 
        plot.title = element_text(color="black", size=30, face="bold")) + 
  labs (y="Percentage of CD45", x = "Day") + 
  theme(strip.text = element_text(size=12, face = "bold")) + theme(legend.position="bottom") +
  ggtitle("Changes in immune cell populations (lung) CD3- CD11b-") +
  stat_compare_means(label = "p.signif", method = "t.test",
                     ref.group = "CNT")

CD3pos_CD11bneg_bar_plot
# CD3neg_CD11bpos_bar_plot
# CD3neg_CD11bneg_bar_plot

```

