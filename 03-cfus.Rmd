---
output: html_document
editor_options: 
  chunk_output_type: console
---

# Colony forming units to determine bacterial counts 

### Downloads

The downloads for this chapter are: 

- [Data collection template] for recording colony forming units counted on each 
plate or section of plate in the laboratory
- [Report template] to process data collected with the data template (when you go to this link, go to the "File" bar in your browser's menu bar, chose "Save As", then save the file as "animal_weights.Rmd")
- [Example output] from the report template

### Overview

In the experiments, we will need to estimate the bacterial load of
*Mycobacterium tuberculosis* in organs---including lungs and spleens---of
animals from experiments. These measurements help us assess how well a vaccine
has worked in comparison to controls.

We will be estimating bacterial load in an animal organ using the plate count
method with serial dilutions. Serial dilutions allow you to create a
highly diluted sample without needing a massive amount of diluent: as you
increase the dilution one step at a time, you can steadily bring the samples
down to lower bacterial loads per volume. This method is common across
laboratories that study tuberculosis drug efficacy as a method for estimating
bacterial load in animal organs [@franzblau2012comprehensive] and is a
well-established method across microbiology in general, dating back to Koch in
the late 1800s [@wilson1922proportion; @ben2014estimation].

With this method, we homogenize part of the organ, and then create several
increasingly dilute samples. Each dilution is then spread on a plate with a
medium in which *Mycobacterium tuberculosis* can grow and left to grow for
several weeks at a temperature conducive to *Mycobacterium tuberculosis* growth.
The idea is that individual bacteria from the original sample end up randomly
spread across the surface of the plate, and any bacteria that are viable
(able to reproduce) will form a new colony that, after a while, you'll be able
to see [@wilson1922proportion; @goldman2015practical]. At the end of this
incubation period, you can count the number of these colony-forming units
(CFUs) on each plate.

To count the number of CFUs, you need a "just right" dilution (and 
we often won't know what this is until after plating) to have a countable
plate. If you have too high of a dilution (i.e., one with very few viable
bacteria), randomness will play a big role in the CFU count, and you'll estimate
the original with more variability, which isn't ideal. If you have too low
of a dilution (i.e., one with lots of viable bacteria), it will be difficult to
identify separate colonies, and they may compete for resources. (The pattern
you see when the dilution is too low (i.e., too concentrated with bacteria) is
called a lawn---colonies merge together).

Once you identify a good dilution for each sample, the CFU count from this
dilution can be used to estimate the bacterial load in the animal's organ. To
translate from diluted concentration to original concentration, you do a
back-calculation, incorporating both the number of colonies counted at that
dilution and how dilute the sample was [@ben2014estimation;
@goldman2015practical].

### Template description

The data are collected in a spreadsheet with multiple sheets. The first sheet
(named "metadata") is used to record some metadata for the experiment, while the 
following sheets are used to record CFUs counts from the plates used for samples
from each organ, with one sheet per organ. For example, if you plated data
from both the lung and spleen, there would be three sheets in the file: one 
with the metadata, one with the plate counts for the lung, and one with the
plate counts for the spleen. 

The metadata sheet is used to record information about the overall process of
plating the data. Values from this sheet will be used in calculating the bacterial
load in the original sample based on the CFU counts. This spreadsheet includes
the following columns: 

- `organ`: Include one row for each organ that was plated in the experiment. 
You should name the organ all in lowercase (e.g., "lung", "spleen"). You 
should use the same name to also name the sheet that records data for that organ
for example, if you have rows in the metadata sheet for "lung" and "spleen", 
then you should have two other sheets in the file, one sheet named "lung" and 
one named "spleen", which you'll use to store the plate counts for each of those
organs.
- `prop_resuspended`: In this column, give the proportion of that organ that 
was plated. For example, if you plated half the lung, then in the "lung" row
of this spread sheet, you should put 0.5 in the `prop_resuspended` column. 
- `total_resuspended_uL`: This column contains an original volume of tissue homogenate. For example, raw lung tissue is homogenized in 500 uL of PBS in a tube containing metal beads. 
- `og_aliquot_uL`: 100 uL of th total_resuspended slurry would be considered an original aliquot and is used to peform serial dilutions.
- `dilution_factor`: Amount of the original stock solution that is present in the total solution, after dilution(s)
- `plated_uL`: Amount of suspension + diluent plated on section of solid agar 

### Processing collected data

### Details of processing script

## Read in data

```{r message = FALSE, warning = FALSE}

library(readxl)
library(dplyr)
library(purrr)
library(tidyr)
library(stringr)
library(tidyverse)
library(gridExtra)
library(ggplot2)
library(ggpubr)

#Replace w/ path to CFU sheet
path <- c("DATA/Copy of baa_cfu_sheet.xlsx")

sheet_names <- excel_sheets(path)
sheet_names <- sheet_names[!sheet_names %in% c("metadata")]

merged_data <- list()

for(i in 1:length(sheet_names)){
  
  data <- read_excel(path, sheet = sheet_names[i]) %>% 
    mutate(organ = paste0(sheet_names[i]))
  
  data <- data %>% 
    #mutate(missing_col = NA) %>% 
    mutate_if(is.double, as.numeric) %>% 
    mutate_if(is.numeric, as.character) %>% 
    pivot_longer(starts_with("dil_"), names_to = "dilution",
                 values_to = "CFUs") %>% 
    mutate(dilution = str_extract(dilution, "[0-9]+"),
           dilution = as.numeric(dilution))
    
  
  merged_data[[i]] <- data
  
  
}
  
all_data <- bind_rows(merged_data, .id = "column_label") %>% 
    select(-column_label)
  
head(merged_data)
head(all_data)
  
```
## Example one

## Exploratory analysis and quality checks

## Exploratory analysis

**Dimensions of input data:**

Based on the input data, data were collected for the following organ or 
organs: 

The following number of mice were included for each: 

The following number of replicates were recorded at each count date for 
each experimental group: 

The following number of dilutions and dilution level were recorded for 
each organ: 

**People who plated and collected the data. Date or dates of counting:**

Based on the input data, the plates included in these data were counted by 
the following person or persons: 
Based on the input data, the plates included in these data were counted on 
the following date or dates: 

```{r}
all_data %>%
  select(organ, who_plated, who_counted, count_date) %>%
  distinct()

head(all_data)
```

**Distribution of CFUs at each dilution:**

Here's a plot that shows how many plates were too numerous to count at each 
dilution level: 

Here is a plot that shows how the CFU counts were distributed by dilution
level in the data: 

## Identify a good dilution for each sample
```{r}
# Make all_data into tidy data and filter for CFUs between 10-75
  
tidy_cfu_data <- all_data %>%
  mutate(dilution = str_extract(dilution, "[0-9]+"),
         dilution = as.numeric(dilution)) %>%
  filter((CFUs >= 5 & CFUs <= 95) | groups == "control") %>%
  mutate(CFUs = as.numeric(CFUs)) 


head(tidy_cfu_data)
```

## Calculate CFUs from best dilution/Estimate bacterial load for each sample based on good dilution
```{r}
# Calculating CFU/ml for every qualifying replicate between 10-75 CFUs. Column binding by organ name to the metadata sheet via inner_join().
meta <- read_excel(path, sheet = "metadata")

tidy_cfu_meta_joined <- inner_join(meta, tidy_cfu_data) %>%
  group_by(groups) %>% 
  mutate(CFUs_per_ml = (CFUs * (dilution_factor^dilution) * 
                          (total_resuspension_mL/volume_plated_ul) * 1000)) %>%
  select(organ, count_date, who_plated, who_counted, groups,  mouse, dilution,  
         CFUs, CFUs_per_ml) %>% 
  ungroup()

head(tidy_cfu_meta_joined)
```

## Create initial report information for these data
```{r}
tidy_lung_cfu_plot <- tidy_cfu_meta_joined %>%
  filter(organ == "lung") %>%
  mutate(group = fct_relevel(groups, "group_1", "group_2", "group_3", "group_4")) %>%
  ggplot(aes(x = groups, y = log10(CFUs_per_ml), fill = groups))+
  stat_boxplot( aes(x = groups, y = log10(CFUs_per_ml)), 
    geom='errorbar', linetype=1, width=0.5)+ 
  geom_boxplot(aes(group = groups), fill = NA, show.legend = FALSE, color = "lightgrey")+
  geom_point(show.legend = FALSE)+
  labs(title = paste0("CFUs in early infected mouse lung"), x = "Group", y = "log10(CFU/mL)",
       color = "Group")+
  guides(shape = "none")+
  theme_minimal()+
  stat_compare_means(label = "p.signif", method = "t.test", ref.group = "group_1") + 
  scale_y_continuous(expand = c(0, 0), limits = c(0, 8))

tidy_lung_cfu_plot
```


## Sample ANOVA
```{r}
cfu_stats <- tidy_cfu_meta_joined %>% 
  group_by(organ) %>%
  nest() %>%
  mutate(aov_result = map(data, ~aov(CFUs_per_ml ~ groups, data = .x)),
         tukey_result = map(aov_result, TukeyHSD),
         tidy_tukey = map(tukey_result, broom::tidy)) %>%
  unnest(tidy_tukey, .drop = TRUE) %>%
  separate(contrast, into = c("contrast1", "contrast2"), sep = "-") %>%
  select(-data, -aov_result, -tukey_result, -term, -null.value)# %>%
  # filter(adj.p.value <= 0.05)

cfu_stats
```

## Save processed data to database


## Example two




